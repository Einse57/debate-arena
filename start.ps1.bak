param(
    [string]$HostAddress = "127.0.0.1",
    [string]$Port = "8001",
    [string]$OvmsPort = "8000",
    [string]$OvmsBaseUrl = $Env:OVMS_BASE_URL
)

# Resolve repo root based on this script location so it works from any CWD.
$repoRoot = if ($PSScriptRoot) { $PSScriptRoot } else { Split-Path -Parent $PSCommandPath }
$backendPath = Join-Path $repoRoot "backend"
$venvActivate = Join-Path $backendPath ".venv/Scripts/Activate.ps1"

if (-not (Test-Path $backendPath)) {
    Write-Error "Backend directory not found at $backendPath"; exit 1
}

if (-not (Test-Path $venvActivate)) {
    Write-Error ".venv not found. Create it first (e.g., python -m venv backend/.venv && pip install -r backend/requirements.txt)."; exit 1
}

# Default OVMS URL if not set anywhere; override via env or parameter.
if (-not $OvmsBaseUrl) { $OvmsBaseUrl = "http://127.0.0.1:$OvmsPort" }
$Env:OVMS_BASE_URL = $OvmsBaseUrl

# Check if OVMS is running
Write-Host "Checking OVMS at $OvmsBaseUrl..." -ForegroundColor Cyan
$ovmsRunning = Test-NetConnection -ComputerName 127.0.0.1 -Port $OvmsPort -InformationLevel Quiet -WarningAction SilentlyContinue

if ($ovmsRunning) {
    Write-Host "âœ“ OVMS is running on port $OvmsPort" -ForegroundColor Green
} else {
    Write-Warning "OVMS is not running on port $OvmsPort"
    Write-Host ""
    Write-Host "To start OVMS, open a separate terminal and run:" -ForegroundColor Yellow
    Write-Host "  With config.json:" -ForegroundColor Cyan
    Write-Host '    ovms --config_path <path-to-config.json> --rest_port 8000 --rest_bind_address 127.0.0.1' -ForegroundColor White
    Write-Host ""
    Write-Host "  Or with a single model:" -ForegroundColor Cyan
    Write-Host '    ovms --model_path <path> --model_name <name> --rest_port 8000 --target_device CPU --task text_generation' -ForegroundColor White
    Write-Host ""
    
    $response = Read-Host "Continue without OVMS? (y/n)"
    if ($response -ne 'y') { exit 1 }
}

Push-Location $backendPath
try {
    Write-Host "Activating venv..." -ForegroundColor Cyan
    . $venvActivate

    Write-Host "Starting API at http://${HostAddress}:${Port} (OVMS_BASE_URL=$($Env:OVMS_BASE_URL))" -ForegroundColor Cyan
    uvicorn app:app --host $HostAddress --port $Port
} finally {
    Pop-Location
}
